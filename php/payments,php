<?php
require_once 'config.php';

header('Content-Type: application/json');

class PaymentHandler {
    private $conn;
    
    public function __construct() {
        $this->conn = getDBConnection();
    }
    
    // Memproses pembayaran
    public function processPayment($data) {
        $this->conn->begin_transaction();
        
        try {
            // Update status order menjadi paid
            $sql = "UPDATE orders SET status = 'paid', payment_method = ?, 
                    payment_reference = ?, paid_at = NOW() WHERE id = ?";
            $stmt = $this->conn->prepare($sql);
            $stmt->bind_param("ssi",
                $data['payment_method'],
                $data['payment_reference'],
                $data['order_id']
            );
            $stmt->execute();
            
            // Catat transaksi pembayaran
            $sql = "INSERT INTO payments (order_id, amount, payment_method, reference_number, status) 
                    VALUES (?, ?, ?, ?, 'completed')";
            $stmt = $this->conn->prepare($sql);
            $stmt->bind_param("idss",
                $data['order_id'],
                $data['amount'],
                $data['payment_method'],
                $data['payment_reference']
            );
            $stmt->execute();
            
            $this->conn->commit();
            return ['success' => true, 'payment_id' => $stmt->insert_id];
            
        } catch (Exception $e) {
            $this->conn->rollback();
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }
    
    // Generate QR Code untuk pembayaran QRIS
    public function generateQRIS($orderId, $amount) {
        // Simulasi generate QRIS
        // Dalam implementasi nyata, ini akan terhubung ke payment gateway
        $referenceNumber = 'QRIS' . date('YmdHis') . $orderId;
        
        return [
            'success' => true,
            'qr_code_url' => 'img/qris.png', // URL QR code
            'reference_number' => $referenceNumber,
            'amount' => $amount,
            'expiry_time' => date('Y-m-d H:i:s', strtotime('+1 hour'))
        ];
    }
    
    // Verifikasi pembayaran
    public function verifyPayment($referenceNumber) {
        $sql = "SELECT * FROM payments WHERE reference_number = ?";
        $stmt = $this->conn->prepare($sql);
        $stmt->bind_param("s", $referenceNumber);
        $stmt->execute();
        $result = $stmt->get_result();
        
        $payment = $result->fetch_assoc();
        
        if ($payment) {
            return [
                'verified' => true,
                'payment' => $payment
            ];
        } else {
            return ['verified' => false];
        }
    }
    
    // Mendapatkan riwayat pembayaran
    public function getPaymentHistory($orderId = null) {
        if ($orderId) {
            $sql = "SELECT p.*, o.customer_name FROM payments p 
                    JOIN orders o ON p.order_id = o.id 
                    WHERE p.order_id = ? ORDER BY p.created_at DESC";
            $stmt = $this->conn->prepare($sql);
            $stmt->bind_param("i", $orderId);
            $stmt->execute();
            $result = $stmt->get_result();
        } else {
            $sql = "SELECT p.*, o.customer_name FROM payments p 
                    JOIN orders o ON p.order_id = o.id 
                    ORDER BY p.created_at DESC LIMIT 50";
            $result = $this->conn->query($sql);
        }
        
        $payments = [];
        while($row = $result->fetch_assoc()) {
            $payments[] = $row;
        }
        
        return $payments;
    }
}

// Handle requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $input = json_decode(file_get_contents('php://input'), true);
    $paymentHandler = new PaymentHandler();
    
    if (isset($input['action'])) {
        switch($input['action']) {
            case 'process':
                $result = $paymentHandler->processPayment($input);
                echo json_encode($result);
                break;
                
            case 'generate_qris':
                $result = $paymentHandler->generateQRIS($input['order_id'], $input['amount']);
                echo json_encode($result);
                break;
                
            case 'verify':
                $result = $paymentHandler->verifyPayment($input['reference_number']);
                echo json_encode($result);
                break;
        }
    }
}

if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    $paymentHandler = new PaymentHandler();
    $orderId = isset($_GET['order_id']) ? $_GET['order_id'] : null;
    $payments = $paymentHandler->getPaymentHistory($orderId);
    echo json_encode($payments);
}
?>